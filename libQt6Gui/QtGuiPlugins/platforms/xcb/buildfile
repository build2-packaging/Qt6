# Note: If anything in this file seems underdocumented it is probably covered
#       in libQt6Core/QtCore/buildfile or libQt5Gui/QtGui/buildfile.
#
include ../../../QtGui/

# C++ source files.
#
# Note that the sources in gl_integrations/ cannot be omitted (even if OpenGL
# is disabled).
#
src = gl_integrations/qxcbglintegration                 \
      gl_integrations/qxcbglintegrationfactory          \
      gl_integrations/qxcbnativeinterfacehandler        \
      qxcbatom                                          \
      qxcbbackingstore                                  \
      qxcbclipboard                                     \
      qxcbconnection                                    \
      qxcbconnection_basic                              \
      qxcbconnection_screens                            \
      qxcbconnection_xi2                                \
      qxcbcursor                                        \
      qxcbdrag                                          \
      qxcbeventdispatcher                               \
      qxcbeventqueue                                    \
      qxcbimage                                         \
      qxcbintegration                                   \
      qxcbkeyboard                                      \
      qxcbmime                                          \
      qxcbnativeinterface                               \
      qxcbscreen                                        \
      qxcbscrollingdevice                               \
      qxcbsessionmanager                                \
      qxcbsystemtraytracker                             \
      qxcbwindow                                        \
      qxcbwmsupport                                     \
      qxcbxsettings

# C++ headers to be moc'd (foo.h -> moc_foo.cpp) and the output included.
#
moc_hdr_adhoc = qxcbclipboard           \
                qxcbconnection          \
                qxcbconnection_basic    \
                qxcbeventdispatcher     \
                qxcbeventqueue          \
                qxcbmime                \
                qxcbnativeinterface     \
                qxcbscrollingdevice_p   \
                qxcbsystemtraytracker

# C++ headers to be moc'd (foo.h -> moc_foo.cpp) and the output compiled.
#
moc_hdr = gl_integrations/qxcbglintegrationplugin \
          qxcbwindow

# C++ sources files to be moc'd (foo.cpp -> foo.moc) and the output included.
#
moc_src_adhoc = qxcbclipboard   \
                qxcbmain        \
                qxcbsessionmanager

# The names of the C++ source files generated by moc from header files (foo.h
# -> moc_foo.cpp) and are included or compiled.
#
moc_gen_src = $regex.apply($moc_hdr_adhoc $moc_hdr, '(.+/)?(.+)', '\1moc_\2')

# The names of the C++ source files generated by moc from header files (foo.h
# -> moc_foo.cpp) and compiled only.
#
moc_gen_obj = $regex.apply($moc_hdr, '(.+/)?(.+)', '\1moc_\2')

# The XCB platform plugin library (implemented by lib{Qt6XcbQpa}).
#
../lib{qxcb}: cxx{qxcbmain} ../lib{Qt6XcbQpa}

# The XCB implementation, shared between lib{qxcb}, lib{qxcb-egl-integration},
# and lib{qxcb-glx-integration} (@@ the latter two not being built yet).
#
../lib{Qt6XcbQpa}: ../../../mkspecs/hxx{**} hxx{** -qt_xlib_wrapper} cxx{$src} \
                   {h c}{qt_xlib_wrapper}

# The "metadata library": its purpose is to make sure all the imported
# libraries are resolved for the ad hoc moc compilation rules.
#
# Note: use a rule hint to resolve ambiguity between C and C++ library.
#
[rule_hint=cxx] libul{Qt6PluginsXcbMeta}: \
  ../../../QtGui/lib{Qt6Gui Qt6GuiPrivate}

# Plugin metadata file.
#
../lib{Qt6XcbQpa}: file{xcb.json}: include = adhoc

# Dependencies involving moc-generated source files.
#

# Dependencies involving lib{Qt6XcbQpa}, moc-generated source files
# (moc_foo.cpp), and the C++ headers they were generated from (for example,
# `moc foo.h` produces moc_foo.cpp).
#
for s: hxx{$moc_hdr_adhoc $moc_hdr}
  $directory($s)/cxx{moc_$name($s)}: $s libul{Qt6PluginsXcbMeta}

for s: hxx{$moc_hdr_adhoc}
  ../lib{Qt6XcbQpa}: $directory($s)/cxx{moc_$name($s)}: include = adhoc

for s: hxx{$moc_hdr}
  ../lib{Qt6XcbQpa}: $directory($s)/cxx{moc_$name($s)}

# Dependencies involving lib{Qt6XcbQpa}, moc-generated source files (foo.moc),
# and the C++ source files the .moc's were generated from (for example, `moc
# foo.cpp` produces foo.moc).
#
for s: cxx{$moc_src_adhoc}
{
  n = $name($s)
  d = $directory($s)

  ../lib{Qt6XcbQpa}: $d/moc{$n}: include = adhoc
  $d/moc{$n}: $s libul{Qt6PluginsXcbMeta}
}

../lib{qxcb}: moc{qxcbmain}: include = adhoc
moc{qxcbmain}: cxx{qxcbmain} libul{Qt6PluginsXcbMeta}

# qxcbclipboard.cpp includes both qxcbclipboard.moc and moc_qxcbclipboard.cpp
# resulting in the transitive dependency `qxcbclipboard.moc ->
# (qxcbclipboard.cpp ->) moc_qxcbclipboard.cpp`.
#
moc{qxcbclipboard}: cxx{moc_qxcbclipboard}

../lib{Qt6XcbQpa qxcb}: libul{Qt6PluginsXcbMeta}

# Build options.
#

# Note: headers in gl_integrations/ are included unconditionally so cannot be
#       excluded even if OpenGL is disabled.
#
cxx.poptions =+ "-I$out_base" "-I$src_base"     \
                "-I$src_base/gl_integrations"

obj{$src $moc_gen_obj} moc{$moc_src_adhoc} cxx{$moc_gen_src}:   \
  cxx.poptions += $lib_macros                                   \
                  -DQT_BUILD_XCB_PLUGIN                         \
                  -DQT_BUILD_XCB_QPA_LIB_LIB

{obj moc}{qxcbmain}: cxx.poptions += $plugin_macros    \
                                     -DQT_XCB_QPA_LIB_LIB

objs{$src}: cxx.poptions += $so_macros

../lib{Qt6XcbQpa}: cxx.libs += -pthread                 \
                               -lICE                    \
                               -lSM                     \
                               -lX11                    \
                               -lX11-xcb                \
                               -lxcb                    \
                               -lxcb-cursor             \
                               -lxcb-icccm              \
                               -lxcb-image              \
                               -lxcb-keysyms            \
                               -lxcb-randr              \
                               -lxcb-render             \
                               -lxcb-render-util        \
                               -lxcb-shape              \
                               -lxcb-shm                \
                               -lxcb-sync               \
                               -lxcb-xfixes             \
                               -lxcb-xinput             \
                               -lxcb-xkb                \
                               -lxkbcommon-x11

if $linux
  ../lib{Qt6XcbQpa}: cxx.libs += -ldl

# Installation.
#
# Note that lib{Qt6XcbQpa} is installed to lib/ along with lib{Qt6Core} and
# lib{Qt6Gui} (unlike lib{qxcb}).
#
../lib{qxcb}: install = lib/qt6/plugins/platforms/
